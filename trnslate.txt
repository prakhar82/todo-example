import { HttpClient } from "@angular/common/http";
import { TranslateLoader } from "@ngx-translate/core";
import { Observable } from "rxjs";
import { AssetsService, AssetsResolverConfig, AssetsResolver } from "@backbase/foundation-ang/core";

/**
 * Description- TranslateHttpLoader class for get traslate file from server using httpClient
 */
  export class TranslateHttpLoader implements TranslateLoader {
    // @TODO need to update below url via assets service.

   defaultPrefix = '/gateway/api/contentservices/api/contentstream/resourceRepository/contextRoot/static/items/bb-ubp-pb360-app-ang/assets/i18n/';

    suffix = '.json';
    
    private config: AssetsResolverConfig = {
      widgetName: 'bb-ubp-pb360-app-ang',
      getURIFromAssetID: (assetId: string) => `${assetId}.json`
    };
   
    resolveAsset: AssetsResolver = this.assetsService.createAssetsResolver(this.config);

    constructor(
      private http: HttpClient,
      private assetsService: AssetsService
      ) {
        // en json assets url
        const assetUrl = this.resolveAsset('en');
      }
  
    /**
     * Gets the translations from the server
     * Case 1 - use translate from server
     * Case 2 - if translate file not returns from server use it from `assets/i18n/{lang}.json`
     */
    public getTranslation(lang: string): Observable<Object> {
      return new Observable((observer) => {
        // @TODO: need to change api static url via app lavel configration. 
        const prefix = "/gateway/api/translations-service/v1/translations?lang="
        this.http.get<Object>(`${prefix}${lang}${this.suffix}`).subscribe((res)=> {
          observer.next(res);
        }, 
        (error)=> {
          // if error comes from server traslate file then use from  contentservices `assets/i18n/{lang}.json`
          this.http.get<Object>(`${this.defaultPrefix}${lang}${this.suffix}`).subscribe((res)=> {
            observer.next(res)
          },
          (error)=> {
            // if error comes from contentservices service then use static service
            this.defaultPrefix = '/gateway/api/portal/static/items/bb-ubp-pb360-app-ang/dist/assets/i18n/';
            this.http.get<Object>(`${this.defaultPrefix}${lang}${this.suffix}`).subscribe((res)=> {
              observer.next(res)
            })
          })
        }
        )
      });
    }
  }